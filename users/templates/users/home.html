{% extends 'users/base.html' %}
{% load static %}
{% block title %}HeadHunter | Работа мечты{% endblock %}

{% block additionals %}
<script>
  const isAuthenticated = "{{ user.is_authenticated }}" === "True";
  // console.log(isAuthenticated);
  const userType = isAuthenticated ? "{{ user.user_type }}" : None;
  // console.log(userType);
  const featuredJobs = isAuthenticated ? JSON.parse("{{ featured_jobs }}") : None;
  // console.log(featuredJobs);
  const respondedJobs = isAuthenticated ? JSON.parse("{{ responded_jobs }}") : None;
  // console.log(respondedJobs);
</script>
{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
      <div class="logo">HeadHunter БСК</div>
      <div class="search-bar">
        <input id="search-input" type="text" placeholder="Поиск вакансий...">
        <select id="industry-filter">
            <option value="">Все отрасли</option>
            <option value="IT">IT</option>
            <option value="Продажи">Продажи</option>
            <option value="Маркетинг">Маркетинг</option>
            <option value="Финансы">Финансы</option>
            <option value="HR">HR</option>
            <!-- Добавьте другие отрасли по необходимости -->
        </select>
        <select id="city-filter">
            <option value="">Все города</option>
            <option value="Москва">Москва</option>
            <option value="Санкт-Петербург">Санкт-Петербург</option>
            <option value="Екатеринбург">Екатеринбург</option>
            <option value="Новосибирск">Новосибирск</option>
            <option value="Красноярск">Красноярск</option>
            <!-- Добавьте другие города по необходимости -->
        </select>
        <button onclick="searchJobs()">Искать</button>
    </div>
    </div>

    <div class="main-content">
      <div class="sidebar">
        <h3>Поиск по отраслям</h3>
        <ul>
          <li><a href="#">IT</a></li>
          <li><a href="#">Продажи</a></li>
          <li><a href="#">Маркетинг</a></li>
          <li><a href="#">Финансы</a></li>
          <li><a href="#">HR</a></li>
          <!-- ... другие отрасли ... -->
        </ul>

        <h3>Поиск по городам</h3>
        <ul>
          <li><a href="#">Москва</a></li>
          <li><a href="#">Санкт-Петербург</a></li>
          <li><a href="#">Екатеринбург</a></li>
          <li><a href="#">Новосибирск</a></li>
          <li><a href="#">Красноярск</a></li>
          <!-- ... другие города ... -->
        </ul>
      </div>

      <div class="vacancy-list" id="vacancy-list">
        <ul id="vacancy-list-ul">
          <script>
            // Функция для выполнения запроса и возврата данных
            function fetchData(url) {
                return fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Ошибка при получении данных с ${url}`);
                        }
                        return response.json();
                    })
                    .catch(error => {
                        console.error(`Ошибка: ${error.message}`);
                        return [];
                    });
            }
        
            // Основная функция загрузки всех данных
            async function loadAllData() {
                try {
                    // Выполняем параллельные запросы к API
                    const [jobs, employers, users] = await Promise.all([
                        fetchData('/jobs/api/jobs/all/'),
                    ]);
                    renderVacancies(jobs, employers, users);
                } catch (error) {
                    console.error('Ошибка при загрузке данных:', error);
                }
            }

            function renderVacancies(jobs = []) {
              const vacancyList = document.getElementById('vacancy-list-ul');
              vacancyList.innerHTML = '';
              // console.log(jobs);
              if (!jobs || jobs.length === 0) {
                  vacancyList.innerHTML = `
                  <li>
                    <div class="vacancy-item empty-list">
                      <h4>Вакансии отсутствуют</h4>
                    </div>
                  </li>`;
                  return;
              }

              jobs.forEach(job => {
                const profilePicture = job['employer']['user']['profile_picture'] || "/static/users/images/user_avatar_default.png";
                const jobElement = document.createElement('li');
                jobElement.innerHTML = `
                    <div class="vacancy-item">
                      <div class="vacancy-main-info">
                        <div class="main-side">
                          <div class="vacancy-image">
                            <img src="${profilePicture}" alt="${job['employer']['company_name']} логотип" class="company-logo">
                          </div>
                          <div>
                            <p class="item-date">${new Date(job['date_of_creation']).toLocaleString()}</p>
                            <h4>${ job['title'] }</h4>
                            <p class="company">${ job['employer']['company_name'] }</p>
                          </div>
                        </div>
                        <div class="vacancy-side-info">
                          <span>${ job['resps'] } откликов</span>
                        </div>
                      </div>
                      <p class="description">${ job['description'] }</p>
                      <div class="job-btns-container">
                        <div class="btns-block" id="btns-block-${job['id']}">
                        </div>
                        <div>
                          <p class="salary">${ job['salary'] }</p>
                        </div>
                      </div>
                    </div>
                `;
                vacancyList.appendChild(jobElement);
                
                const btns_lst = document.getElementById(`btns-block-${job['id']}`);
                
                if (isAuthenticated){ 
                  if (featuredJobs && !featuredJobs.includes(job['id'])){
                    btns_lst.innerHTML += `<a class="btn learn-more" href="/jobs/create/feature/${job['id']}"><i class="fi fi-ss-heart"></i></a>`
                  }
                  else {
                    btns_lst.innerHTML += `<a class="btn learn-more featured" href="/jobs/delete/feature/${job['id']}"><i class="fi fi-ss-heart"></i></a>`
                  }
                }

                btns_lst.innerHTML += `<a class="btn learn-more" href="jobs/view/job/${job['id']}/">Подробнее</a>`
                
                if (isAuthenticated){
                  if (userType == 'seeker'){
                    if (respondedJobs.includes(job['id'])){
                      btns_lst.innerHTML += `<span class="btn btn-invert responded">Вы откликнулись</span>`
                    }
                    else{
                      btns_lst.innerHTML += `<a class="btn btn-invert" href="/jobs/create/response/${job['id']}">Откликнуться</a>`
                    }
                  }
                  if (userType == 'employer'){
                    btns_lst.innerHTML += `<a class="btn btn-invert close" href="/jobs/delete/job/${job['id']}">Закрыть</a>`
                  }
                }
              });
            }

            document.addEventListener('DOMContentLoaded', loadAllData);
        </script>
      </ul>
    </div>
  </div>
  <script>
    function searchJobs() {
        const query = document.getElementById('search-input').value.trim();
        const industry = document.getElementById('industry-filter').value;
        const city = document.getElementById('city-filter').value;

        let params = `?q=${encodeURIComponent(query)}`;
        if (industry) {
            params += `&industry=${encodeURIComponent(industry)}`;
        }
        if (city) {
            params += `&city=${encodeURIComponent(city)}`;
        }

        fetch(`/jobs/api/jobs/search/${params}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сети');
                }
                return response.json();
            })
            .then(data => { 
              // console.log(data);
              renderVacancies(data) 
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert(`Произошла ошибка: ${error.message}`);
            });
    }

    document.getElementById('search-input').addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            searchJobs();
        }
    });
</script>
{% endblock %}